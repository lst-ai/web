<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡å‹•è©å¤§å¯Œç¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Custom font for better Chinese character display */
        body {
            font-family: 'Inter', 'Noto Sans TC', 'BiauKai', 'DFKai-SB', 'KaiTi', 'serif';
            display: flex;
            flex-direction: column; /* Allow vertical stacking for footer */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8; /* Light blue-gray background */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Board layout using CSS Grid */
        .board {
            display: grid;
            /* 11x11 grid for 40 spaces (10 per side + corners) */
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            width: 100%;
            max-width: 900px; /* Max width for the board */
            aspect-ratio: 1 / 1; /* Keep it square */
            background-color: #e0f2f7; /* Light cyan background for board */
            border: 8px solid #64b5f6; /* Light blue border */
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative; /* For player token absolute positioning */
            padding: 10px; /* Inner padding for spaces */
        }

        /* Styling for each board space (card) */
        .board-space {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f5deb3; /* Light brown for unvisited spaces */
            border: 2px solid #d2b48c; /* Darker brown border */
            border-radius: 10px;
            font-size: 1.8rem; /* Increased font size for clarity */
            font-weight: bold;
            color: #333;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            text-align: center;
            padding: 5px; /* Add padding for verb text */
            word-break: keep-all; /* Prevent breaking single Chinese characters */
        }

        .board-space.current {
            background-color: #ffe0b2; /* Light orange for current space */
            border-color: #ff9800; /* Orange border */
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.6);
        }

        .board-space.visited {
            background-color: #a7d9f7; /* Light blue for visited spaces */
            border-color: #64b5f6; /* Darker blue border */
        }

        /* Player token styling */
        .player-token {
            position: absolute;
            border-radius: 50%;
            width: 35px; /* Slightly larger token */
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem; /* Smaller font for token ID */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Springy movement */
            z-index: 10;
        }

        /* Center area for controls and verb display */
        #centerArea {
            grid-column: 2 / span 9; /* Spans 9 columns for 11x11 grid */
            grid-row: 2 / span 9; /* Spans 9 rows for 11x11 grid */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            z-index: 5; /* Ensure it's above board spaces but below token */
        }

        /* Slot Machine Display */
        #slotMachineDisplay {
            width: 120px; /* Fixed size for the display */
            height: 120px;
            border-radius: 15px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            background-color: #f0f0f0; /* Light background */
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem; /* Large font for numbers */
            font-weight: bold;
            color: #2c3e50; /* Dark blue-gray for numbers */
            overflow: hidden; /* Hide spinning numbers outside */
            position: relative;
        }

        /* Footer styling */
        .footer {
            margin-top: 30px;
            font-size: 0.9rem;
            color: #555;
            text-align: center;
        }
        .footer a {
            color: #4a90e2;
            text-decoration: none;
            font-weight: bold;
        }
        .footer a:hover {
            text-decoration: underline;
        }

        /* Player selection and initial screen */
        #playerSetup {
            margin-bottom: 20px;
            padding: 25px; /* Increased padding */
            background-color: #e0f7fa; /* Light blue background */
            border-radius: 15px; /* More rounded */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* Stronger shadow */
            width: 100%;
            max-width: 500px; /* Wider for titles */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px; /* More space between elements */
        }
        #playerSetup h1 {
            font-size: 2.5rem; /* Larger main title */
            font-weight: bold;
            color: #2c3e50; /* Darker blue-gray */
            margin-bottom: 10px;
            line-height: 1.2; /* Adjust line height for two lines */
        }
        #playerSetup p {
            font-size: 1.2rem; /* Larger subtitle */
            color: #34495e; /* Medium blue-gray */
            margin-bottom: 20px;
        }

        /* Celebration Overlay */
        #celebrationOverlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        }
        #celebrationOverlay.show {
            opacity: 1;
            visibility: visible;
        }
        #celebrationOverlay > div {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: bounceIn 0.8s ease-out forwards;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .board {
                max-width: 95%;
                height: auto; /* Allow height to adjust */
            }
            .board-space {
                font-size: 1.2rem; /* Adjusted for smaller screens */
                border-radius: 8px;
            }
            .player-token {
                width: 25px;
                height: 25px;
                font-size: 0.7rem;
            }
            #slotMachineDisplay {
                width: 100px;
                height: 100px;
                margin-bottom: 15px;
                font-size: 4rem;
            }
            #rollDiceBtn {
                padding: 10px 20px;
                font-size: 1.1rem;
            }
            #verbDisplay {
                font-size: 3rem;
            }
            #instructions {
                font-size: 0.9rem;
            }
            #gameTitle {
                font-size: 2rem;
            }
            .footer {
                font-size: 0.8rem;
            }
            #playerSetup {
                padding: 15px;
            }
            #playerSetup h1 {
                font-size: 2rem;
            }
            #playerSetup p {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .board-space {
                font-size: 1rem; /* Further adjusted for smallest screens */
                border-radius: 6px;
                padding: 2px;
            }
            .player-token {
                width: 20px;
                height: 20px;
                font-size: 0.6rem;
            }
            #slotMachineDisplay {
                width: 80px;
                height: 80px;
                margin-bottom: 10px;
                font-size: 3rem;
            }
            #rollDiceBtn {
                padding: 8px 16px;
                font-size: 1rem;
            }
            #verbDisplay {
                font-size: 2.5rem;
            }
            #instructions {
                font-size: 0.8rem;
            }
            #gameTitle {
                font-size: 1.5rem;
            }
            .footer {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div id="playerSetup" class="flex flex-col items-center gap-4">
        <h1 class="text-4xl font-extrabold text-gray-800">
            <span>LSTéŠæˆ²å®¤-</span><br>
            <span>ä¸­æ–‡å‹•è©å¤§å¯Œç¿éŠæˆ²</span>
        </h1>
        <p class="text-xl text-gray-600">éŠæˆ²ä¸­å­¸ç¿’å‹•è©ï¼Œä¸€èµ·ä¾†æ„Ÿå—èªæ–‡çš„æ¨‚è¶£ï¼</p>
        <label for="numPlayers" class="text-lg font-semibold text-gray-800">é¸æ“‡çµ„åˆ¥æ•¸é‡:</label>
        <select id="numPlayers" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            <option value="1">1 çµ„</option>
            <option value="2">2 çµ„</option>
            <option value="3">3 çµ„</option>
            <option value="4">4 çµ„</option>
        </select>
        <button id="startGameBtn" class="px-6 py-2 bg-blue-500 text-white font-bold rounded-full shadow-lg hover:bg-blue-600 transition duration-300">
            é–‹å§‹éŠæˆ²
        </button>
    </div>

    <div class="board hidden">
        <div id="centerArea">
            <h1 id="gameTitle" class="text-4xl font-extrabold text-blue-800 mb-6">ä¸­æ–‡å‹•è©å¤§å¯Œç¿éŠæˆ²</h1>
            <div id="slotMachineDisplay">?</div>
            <button id="rollDiceBtn" class="px-8 py-4 bg-green-500 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-105">
                æ“²éª°å­
            </button>
            <div id="verbDisplay" class="mt-8 text-7xl font-extrabold text-purple-700 text-center"></div>
            <div id="instructions" class="mt-4 text-xl text-gray-700 text-center">
                è«‹è¡¨æ¼”é€™å€‹å‹•è©ï¼
            </div>
        </div>
        <div id="playerTokensContainer">
            </div>
    </div>

    <div class="footer">
        <p>éŠæˆ²è¨­è¨ˆï¼šåŠ‰å®é¾ï½œè£½ä½œï¼šå‘‚èˆ’å©·ï½œ
            <a href="https://www.facebook.com/yobi.lu" target="_blank">ğŸ” FB</a>ï½œ
            ğŸ“§ <a href="mailto:luuyobi@gmail.com">luuyobi@gmail.com</a>
        </p>
    </div>

    <div id="celebrationOverlay" class="hidden">
        <div>
            <h2 class="text-5xl font-extrabold text-yellow-500">æ­å–œå®Œæˆä¸€åœˆï¼</h2>
            <p class="text-2xl text-gray-700 mt-4">ç¹¼çºŒåŠªåŠ›ï¼</p>
        </div>
    </div>

    <script>
        // ç¢ºä¿åœ¨ DOM å®Œå…¨è¼‰å…¥å¾ŒåŸ·è¡Œè…³æœ¬
        window.onload = function() {
            // ä¸­æ–‡å–®å­—å‹•è©åˆ—è¡¨ (ç¢ºä¿æœ‰è¶³å¤ çš„å‹•è©çµ¦40å¼µå¡ç‰‡ï¼Œä¸”å¯è¡¨æ¼”)
            let chineseVerbs = [
                "èµ°", "è·‘", "è·³", "å", "ç«™", "èºº", "èªª", "è½", "çœ‹", "åƒ",
                "å–", "å¯«", "è®€", "ç•«", "å”±", "èˆ", "ç¬‘", "å“­", "ç¡", "é†’",
                "é–‹", "é—œ", "æ‹¿", "æ”¾", "çµ¦", "æ”¶", "è²·", "è³£", "åš", "ç”¨",
                "å­¸", "æ•™", "å•", "ç­”", "æ‰¾", "ä¸Ÿ", "æ’¿", "ç©¿", "è„«", "ç©",
                "æƒ³", "è¨˜", "æ‘¸", "æ¨", "æ‹‰", "æ‹", "è¸¢", "æŠ±",
                "è¿½", "èº²", "é£›", "æ¸¸", "çˆ¬", "å‰ª", "ç¸«", "ç…®", "ç‚’", "çƒ¤",
                "æ´—", "æ“¦", "æƒ", "æ‹–", "æ¬", "é€", "æ¥", "å€Ÿ", "é‚„",
                "ç¨®", "æ‘˜", "æŒ–", "åŸ‹", "è“‹", "å †", "ç–Š", "æ‹†", "ä¿®", "å»º",
                "é»", "æŒ‰", "æ»‘", "æ•²", "èˆ‰", "æ²", "é‹ª", "æ’•", "è²¼", "è·º"
            ];

            // éŠæˆ²æ¿æ ¼å­çš„åº§æ¨™æ˜ å°„ (row, col) for an 11x11 grid
            // ç¸½å…± 40 å€‹æ ¼å­ (10 per side)
            const boardPositions = [
                // Top row (11 spaces: 0-10)
                [1,1], [1,2], [1,3], [1,4], [1,5], [1,6], [1,7], [1,8], [1,9], [1,10], [1,11],
                // Right column (10 spaces: 11-20, excluding top-right corner)
                [2,11], [3,11], [4,11], [5,11], [6,11], [7,11], [8,11], [9,11], [10,11], [11,11],
                // Bottom row (10 spaces: 21-30, excluding bottom-right corner)
                [11,10], [11,9], [11,8], [11,7], [11,6], [11,5], [11,4], [11,3], [11,2], [11,1],
                // Left column (9 spaces: 31-39, excluding bottom-left and top-left corners)
                [10,1], [9,1], [8,1], [7,1], [6,1], [5,1], [4,1], [3,1], [2,1]
            ];

            // éŠæˆ²ç‹€æ…‹è®Šæ•¸
            let players = []; // Array of { id: string, position: number, color: string, tokenElement: HTMLElement, hasCompletedRound: boolean }
            let currentPlayerIndex = 0;
            const numSpaces = boardPositions.length;
            const visitedSpaces = new Array(numSpaces).fill(false); // è¿½è¹¤å¡ç‰‡æ˜¯å¦è¢«è¨ªå•é

            // DOM å…ƒç´ å¼•ç”¨
            const playerSetupDiv = document.getElementById('playerSetup');
            const numPlayersSelect = document.getElementById('numPlayers');
            const startGameBtn = document.getElementById('startGameBtn');
            const boardElement = document.querySelector('.board');
            const playerTokensContainer = document.getElementById('playerTokensContainer');
            const rollDiceBtn = document.getElementById('rollDiceBtn');
            const verbDisplay = document.getElementById('verbDisplay');
            const instructionsDisplay = document.getElementById('instructions');
            const slotMachineDisplay = document.getElementById('slotMachineDisplay');
            const celebrationOverlay = document.getElementById('celebrationOverlay');

            let boardSpaces = []; // å„²å­˜æ‰€æœ‰æ ¼å­å…ƒç´ çš„é™£åˆ—
            let assignedVerbs = []; // å„²å­˜åˆ†é…çµ¦æ¯å€‹æ ¼å­çš„å‹•è©

            // ç©å®¶æ£‹å­é¡è‰²åˆ—è¡¨
            const playerColors = ['#ef4444', '#3b82f6', '#10b981', '#f97316']; // Red, Blue, Green, Orange

            // --- Tone.js Sound Effects ---
            const slotRollSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.01, decay: 0.05, sustain: 0.05, release: 0.1 }
            }).toDestination();

            const landSoundSynth = new Tone.Synth({
                oscillator: { type: "triangle" },
                envelope: { attack: 0.02, decay: 0.2, sustain: 0.1, release: 0.3 }
            }).toDestination();

            const celebrationSynth = new Tone.Synth().toDestination();
            const celebrationMelody = [
                { note: "C5", time: 0, duration: "8n" },
                { note: "E5", time: "8n", duration: "8n" },
                { note: "G5", time: "4n", duration: "4n" },
                { note: "C6", time: "2n", duration: "2n" }
            ];

            /**
             * æ’­æ”¾æ…¶ç¥éŸ³æ¨‚
             */
            function playCelebrationMusic() {
                const now = Tone.now();
                celebrationMelody.forEach(note => {
                    celebrationSynth.triggerAttackRelease(note.note, note.duration, now + note.time);
                });
            }

            /**
             * Fisher-Yates (Knuth) shuffle algorithm to randomize verbs
             * @param {Array} array - The array to shuffle
             * @returns {Array} - The shuffled array
             */
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]]; // Swap elements
                }
                return array;
            }

            /**
             * å‰µå»ºéŠæˆ²æ¿ä¸Šçš„æ‰€æœ‰æ ¼å­ä¸¦åˆ†é…å‹•è©
             */
            function createBoardSpaces() {
                // ç¢ºä¿å‹•è©åˆ—è¡¨è¶³å¤ ä¸”éš¨æ©Ÿ
                const shuffledVerbs = shuffleArray([...chineseVerbs]);
                assignedVerbs = shuffledVerbs.slice(0, numSpaces); // å–å‰ numSpaces å€‹å‹•è©

                for (let i = 0; i < numSpaces; i++) {
                    const space = document.createElement('div');
                    space.classList.add('board-space');
                    space.id = `space-${i}`;

                    if (i === 0) {
                        // First space: directional arrow
                        space.innerHTML = `
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        `;
                    } else {
                        space.textContent = assignedVerbs[i]; // Directly display verb on card
                    }

                    // Set grid-area properties for positioning
                    space.style.gridRowStart = boardPositions[i][0];
                    space.style.gridColumnStart = boardPositions[i][1];
                    boardElement.appendChild(space);
                    boardSpaces.push(space);
                }
            }

            /**
             * åˆå§‹åŒ–ç©å®¶çµ„åˆ¥å’Œæ£‹å­
             * @param {number} count - ç©å®¶çµ„åˆ¥æ•¸é‡
             */
            function initializePlayers(count) {
                players = [];
                playerTokensContainer.innerHTML = ''; // Clear existing tokens

                for (let i = 0; i < count; i++) {
                    const tokenElement = document.createElement('div');
                    tokenElement.classList.add('player-token');
                    tokenElement.style.backgroundColor = playerColors[i % playerColors.length];
                    tokenElement.id = `player-token-${i}`;
                    playerTokensContainer.appendChild(tokenElement);

                    players.push({
                        id: `çµ„åˆ¥ ${i + 1}`,
                        position: 0,
                        color: playerColors[i % playerColors.length],
                        tokenElement: tokenElement,
                        hasCompletedRound: false // Track if this player has completed a full round
                    });
                }
                updatePlayerTokenPositions(); // Initial placement
                updateInstructionsDisplay(); // Show initial turn
            }

            /**
             * æ›´æ–°æ‰€æœ‰ç©å®¶æ£‹å­çš„ä½ç½®
             */
            function updatePlayerTokenPositions() {
                players.forEach(player => {
                    const targetSpace = boardSpaces[player.position];
                    if (targetSpace) {
                        const spaceRect = targetSpace.getBoundingClientRect();
                        const boardRect = boardElement.getBoundingClientRect();

                        // Calculate token position relative to the board
                        // Offset tokens slightly if multiple players are on the same space
                        const offset = players.indexOf(player) * 5; // Small offset for visibility
                        player.tokenElement.style.left = `${spaceRect.left - boardRect.left + (spaceRect.width / 2) - (player.tokenElement.offsetWidth / 2) + offset}px`;
                        player.tokenElement.style.top = `${spaceRect.top - boardRect.top + (spaceRect.height / 2) - (player.tokenElement.offsetHeight / 2) + offset}px`;
                    }
                });
            }

            /**
             * æ›´æ–°æŒ‡ç¤ºé¡¯ç¤ºï¼ŒåŒ…æ‹¬ç•¶å‰ç©å®¶å›åˆ
             */
            function updateInstructionsDisplay(message = "è«‹æ“²éª°å­ï¼") {
                const currentPlayer = players[currentPlayerIndex];
                instructionsDisplay.innerHTML = `ç¾åœ¨æ˜¯ <span style="color: ${currentPlayer.color}; font-size: 1.2em; font-weight: bold;">${currentPlayer.id}</span> çš„å›åˆï¼Œ${message}`;
            }

            /**
             * æ ¹æ“š visitedSpaces é™£åˆ—æ›´æ–°å¡ç‰‡é¡è‰²
             */
            function updateSpaceColors() {
                boardSpaces.forEach((space, index) => {
                    if (visitedSpaces[index]) {
                        space.classList.add('visited');
                    } else {
                        space.classList.remove('visited');
                    }
                });
                // Ensure current player's space is highlighted
                boardSpaces.forEach((space, index) => {
                    space.classList.remove('current');
                });
                boardSpaces[players[currentPlayerIndex].position].classList.add('current');
            }

            /**
             * ç”Ÿæˆå¸¶æœ‰æ¬Šé‡çš„éš¨æ©Ÿæ•¸å­— (1-7, æ•¸å­—è¶Šå°æ©Ÿç‡è¶Šé«˜)
             * @returns {number} - éš¨æ©Ÿç”Ÿæˆçš„æ•¸å­—
             */
            function getWeightedRandomNumber() {
                const weightedNumbers = [
                    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 10 times for 1
                    2, 2, 2, 2, 2, 2, 2, 2,       // 8 times for 2
                    3, 3, 3, 3, 3, 3,             // 6 times for 3
                    4, 4, 4, 4,                   // 4 times for 4
                    5, 5,                         // 2 times for 5
                    6,                            // 1 time for 6
                    7                             // 1 time for 7
                ];
                const randomIndex = Math.floor(Math.random() * weightedNumbers.length);
                return weightedNumbers[randomIndex];
            }

            let slotMachineInterval;
            /**
             * æ¨¡æ“¬æ‹‰éœ¸æ©Ÿè½‰å‹•ä¸¦é¡¯ç¤ºæœ€çµ‚çµæœ
             * @param {number} finalResult - æ‹‰éœ¸æ©Ÿçš„æœ€çµ‚çµæœ
             * @returns {Promise<void>} - Promise that resolves when slot machine animation is complete
             */
            function rollSlotMachineAnimation(finalResult) {
                return new Promise(resolve => {
                    let spinCount = 0;
                    const totalSpins = 20; // Number of times the number will change rapidly
                    const spinDuration = 50; // Milliseconds per spin change

                    slotMachineInterval = setInterval(() => {
                        if (spinCount < totalSpins) {
                            slotMachineDisplay.textContent = Math.floor(Math.random() * 7) + 1; // Random number 1-7
                            slotRollSynth.triggerAttackRelease("C3", "32n"); // Short sound for each spin
                            spinCount++;
                        } else {
                            clearInterval(slotMachineInterval);
                            slotMachineDisplay.textContent = finalResult; // Display final result
                            resolve(); // Animation complete
                        }
                    }, spinDuration);
                });
            }


            /**
             * æ“²éª°å­ (ç¾åœ¨æ˜¯æ‹‰éœ¸æ©Ÿ) ä¸¦ç§»å‹•ç©å®¶
             */
            async function rollDice() {
                // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
                rollDiceBtn.disabled = true;
                rollDiceBtn.textContent = "ç§»å‹•ä¸­...";
                verbDisplay.textContent = ""; // æ¸…ç©ºå‹•è©é¡¯ç¤º
                instructionsDisplay.textContent = ""; // æ¸…ç©ºèªªæ˜

                const slotResult = getWeightedRandomNumber(); // Get weighted random number

                // åŸ·è¡Œæ‹‰éœ¸æ©Ÿå‹•ç•«
                await rollSlotMachineAnimation(slotResult);

                let stepsMoved = 0;
                const currentPlayer = players[currentPlayerIndex];
                const oldPosition = currentPlayer.position;

                const moveInterval = setInterval(() => {
                    if (stepsMoved < slotResult) {
                        // æ¯æ¬¡ç§»å‹•ä¸€æ­¥ä¸¦æ›´æ–°æ£‹å­ä½ç½®
                        currentPlayer.position = (currentPlayer.position + 1);
                        // Check if player crossed the start line
                        if (currentPlayer.position >= numSpaces) {
                            currentPlayer.hasCompletedRound = true;
                            currentPlayer.position %= numSpaces; // Wrap around
                        }
                        updatePlayerTokenPositions(); // Update all tokens
                        stepsMoved++;
                    } else {
                        clearInterval(moveInterval);
                        // ç§»å‹•å®Œæˆå¾Œï¼ŒåŸ·è¡Œå‹•è©è¡¨æ¼”
                        landSoundSynth.triggerAttackRelease("G4", "8n"); // Play land sound

                        // Check for celebration if landed on start after completing a round
                        if (currentPlayer.position === 0 && currentPlayer.hasCompletedRound) {
                            playCelebrationMusic();
                            celebrationOverlay.classList.remove('hidden');
                            celebrationOverlay.classList.add('show');
                            setTimeout(() => {
                                celebrationOverlay.classList.remove('show');
                                celebrationOverlay.classList.add('hidden');
                            }, 3000); // Hide celebration after 3 seconds
                            currentPlayer.hasCompletedRound = false; // Reset for next round
                        }

                        performVerbAction();
                        // Mark space as visited only if it's the first time
                        if (!visitedSpaces[currentPlayer.position]) {
                            visitedSpaces[currentPlayer.position] = true;
                        }
                        updateSpaceColors(); // Update card colors

                        // åˆ‡æ›åˆ°ä¸‹ä¸€ä½ç©å®¶
                        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                        updateInstructionsDisplay(); // Update instructions for next turn

                        // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
                        rollDiceBtn.disabled = false;
                        rollDiceBtn.textContent = "æ“²éª°å­";
                    }
                }, 300); // æ¯ 300 æ¯«ç§’ç§»å‹•ä¸€æ­¥
            }

            /**
             * é¸æ“‡ç•¶å‰ä½ç½®çš„å‹•è©ä¸¦é¡¯ç¤º
             */
            function performVerbAction() {
                const currentPlayer = players[currentPlayerIndex];
                const selectedVerb = assignedVerbs[currentPlayer.position];

                if (currentPlayer.position === 0) { // If on the start space
                    verbDisplay.textContent = "èµ·é»";
                    updateInstructionsDisplay("è«‹æ“²éª°å­ï¼");
                } else if (visitedSpaces[currentPlayer.position]) {
                    // If the space has been visited by any team
                    verbDisplay.textContent = "æ­¤å‹•è©å·²è¡¨æ¼”é";
                    updateInstructionsDisplay("æ­¤å‹•è©å·²è¡¨æ¼”éï¼Œè«‹ç­‰å¾…ä¸‹ä¸€å›åˆï¼");
                } else {
                    verbDisplay.textContent = selectedVerb;
                    updateInstructionsDisplay(`è«‹è¡¨æ¼” "${selectedVerb}" é€™å€‹å‹•è©ï¼`);
                }
            }

            // Start Game Button Event Listener
            startGameBtn.addEventListener('click', () => {
                const selectedNumPlayers = parseInt(numPlayersSelect.value);
                // Remove player setup div completely
                playerSetupDiv.remove();
                boardElement.classList.remove('hidden'); // Show board

                createBoardSpaces(); // Create board spaces with verbs
                initializePlayers(selectedNumPlayers); // Initialize players and tokens
            });

            // ç¶å®šæ“²éª°å­æŒ‰éˆ•äº‹ä»¶
            rollDiceBtn.addEventListener('click', rollDice);

            // ç¢ºä¿è¦–çª—å¤§å°æ”¹è®Šæ™‚æ£‹å­ä½ç½®æ­£ç¢º
            window.addEventListener('resize', () => {
                // Update player token positions
                updatePlayerTokenPositions();
            });
        };
    </script>
</body>
</html>
