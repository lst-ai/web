<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LST遊戲室-趣味造句機</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body {
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* For animation effects */
        }
        .header-title {
            background: linear-gradient(135deg, #6dd5ed, #2193b0);
            color: white;
            padding: 20px;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            text-align: center;
            position: relative; /* For settings button positioning */
        }
        .spinner-section {
            background-color: #e9ecef;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .spinner-item {
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 1.1rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: #343a40;
        }
        .pull-lever {
            font-size: 3rem;
            cursor: pointer;
            color: #dc3545; /* Red */
            transition: transform 0.2s ease-in-out;
        }
        .pull-lever:active {
            transform: translateY(5px);
        }
        .input-section {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .btn-submit {
            background-color: #28a745; /* Green */
            border-color: #28a745;
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border-radius: 8px;
        }
        .btn-submit:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .alert-message {
            margin-top: 15px;
            text-align: center;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
            border-radius: 15px; /* Match card border-radius */
        }
        .settings-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            color: white;
            cursor: pointer;
            z-index: 10;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .settings-btn:hover {
            opacity: 1;
        }
        /* Modal specific styles */
        .modal-header {
            background-color: #007bff;
            color: white;
            border-top-left-radius: calc(0.5rem - 1px);
            border-top-right-radius: calc(0.5rem - 1px);
        }
        .modal-body .form-group {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="app" class="container my-5" style="max-width: 600px; position: relative;">
        <div class="card">
            <!-- Loading Overlay -->
            <transition name="fade">
                <div v-if="isLoading" class="loading-overlay animate__animated animate__fadeIn">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>{{ loadingMessage }}</span>
                </div>
            </transition>

            <div class="header-title">
                <h1 class="mb-0"><i class="bi bi-card-text"></i> LST遊戲室-趣味造句機</h1>
                <i class="bi bi-gear-fill settings-btn" @click="openPasswordModal"></i>
            </div>

            <!-- 拉霸區 -->
            <div class="spinner-section">
                <div class="row w-100">
                    <div class="col-4" v-for="(item, index) in spinnerItems" :key="index">
                        <div :class="['spinner-item', { 'animate__animated': isSpinning[index], 'animate__bounceIn': isSpinning[index] }]"
                             @animationend="isSpinning[index] = false">
                            {{ item }}
                        </div>
                    </div>
                </div>
                <i class="bi bi-arrow-down-circle-fill pull-lever" @click="pullLever"></i>
            </div>

            <!-- 資料輸入區 -->
            <div class="input-section">
                <div class="mb-3">
                    <label for="userName" class="form-label">您的姓名</label>
                    <input type="text" class="form-control" id="userName" v-model="userName" placeholder="請輸入您的姓名">
                </div>
                <div class="mb-3">
                    <label for="sentence" class="form-label">您的造句</label>
                    <textarea class="form-control" id="sentence" rows="3" v-model="userSentence" placeholder="請使用上方提供的詞語造句..."></textarea>
                </div>
                <button type="button" class="btn btn-primary btn-submit" @click="submitSentence">
                    <i class="bi bi-send-fill me-2"></i>送出造句
                </button>
                <div v-if="message" :class="['alert', messageType, 'alert-message', 'animate__animated', messageAnimation]"
                     @animationend="messageAnimation = ''" role="alert">
                    {{ message }}
                </div>
            </div>
        </div>

        <!-- 密碼輸入 Modal -->
        <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="passwordModalLabel"><i class="bi bi-lock-fill me-2"></i>輸入密碼</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">管理員密碼:</label>
                            <input type="password" class="form-control" id="adminPassword" v-model="adminPasswordInput" @keyup.enter="verifyPasswordAndOpenSettings" placeholder="請輸入管理員密碼">
                        </div>
                        <div v-if="passwordError" class="alert alert-danger mt-3" role="alert">
                            {{ passwordError }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="verifyPasswordAndOpenSettings">驗證</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 設定 Modal -->
        <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="settingsModalLabel"><i class="bi bi-gear-fill me-2"></i>設定拉霸欄位</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted">請選擇三個用於拉霸的詞語類型。</p>
                        <div class="form-group mb-3">
                            <label for="slot1" class="form-label">欄位 1:</label>
                            <select id="slot1" class="form-select" v-model="tempSettings.slot1">
                                <option v-for="col in availableColumns" :value="col">{{ col }}</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="slot2" class="form-label">欄位 2:</label>
                            <select id="slot2" class="form-select" v-model="tempSettings.slot2">
                                <option v-for="col in availableColumns" :value="col">{{ col }}</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="slot3" class="form-label">欄位 3:</label>
                            <select id="slot3" class="form-select" v-model="tempSettings.slot3">
                                <option v-for="col in availableColumns" :value="col">{{ col }}</option>
                            </select>
                        </div>
                        <div v-if="settingsMessage" class="alert alert-danger mt-3" role="alert">
                            {{ settingsMessage }}
                        </div>

                        <hr class="my-4">
                        <h6><i class="bi bi-key-fill me-2"></i>修改管理員密碼</h6>
                        <div class="form-group mb-3">
                            <label for="newPassword" class="form-label">新密碼:</label>
                            <input type="password" class="form-control" id="newPassword" v-model="newPassword" placeholder="輸入新密碼">
                        </div>
                        <div class="form-group mb-3">
                            <label for="confirmNewPassword" class="form-label">確認新密碼:</label>
                            <input type="password" class="form-control" id="confirmNewPassword" v-model="confirmNewPassword" placeholder="再次輸入新密碼">
                        </div>
                        <button type="button" class="btn btn-warning w-100" @click="changeAdminPassword">
                            <i class="bi bi-pencil-square me-2"></i>修改密碼
                        </button>
                        <div v-if="passwordChangeMessage" :class="['alert', passwordChangeMessageType, 'mt-3']" role="alert">
                            {{ passwordChangeMessage }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="saveSettings">儲存拉霸設定</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1KbbFUarXkCJSKCKVw/sQe9BfKx" crossorigin="anonymous"></script>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    spinnerItems: ['載入中...', '載入中...', '載入中...'], // 初始顯示載入中
                    userName: '',
                    userSentence: '',
                    message: '',
                    messageType: '',
                    messageAnimation: '',
                    isLoading: false,
                    loadingMessage: '載入中...',
                    isSpinning: [false, false, false], // 控制每個 spinner-item 的動畫

                    // 密碼相關資料
                    passwordModal: null, // Bootstrap Modal instance for password
                    adminPasswordInput: '',
                    passwordError: '',

                    // 設定相關資料
                    settingsModal: null, // Bootstrap Modal instance for settings
                    availableColumns: [], // 從 Google Apps Script 獲取的所有可用欄位
                    currentSettings: { // 實際生效的設定，從 Apps Script 讀取
                        slot1: '名詞(人物)',
                        slot2: '動詞',
                        slot3: '修辭'
                    },
                    tempSettings: { // 暫存使用者在設定 Modal 中選擇的設定
                        slot1: '名詞(人物)',
                        slot2: '動詞',
                        slot3: '修辭'
                    },
                    settingsMessage: '', // 設定 Modal 中的錯誤訊息

                    // 修改密碼相關資料
                    newPassword: '',
                    confirmNewPassword: '',
                    passwordChangeMessage: '',
                    passwordChangeMessageType: ''
                };
            },
            mounted() {
                // 檢查 Bootstrap 是否已載入
                if (typeof bootstrap !== 'undefined') {
                    console.log("Bootstrap is loaded successfully!");
                    // 初始化 Bootstrap Modal 實例
                    const passwordModalElement = document.getElementById('passwordModal');
                    if (passwordModalElement) {
                        this.passwordModal = new bootstrap.Modal(passwordModalElement);
                    } else {
                        console.error("Error: passwordModal element not found for Bootstrap Modal initialization.");
                    }

                    const settingsModalElement = document.getElementById('settingsModal');
                    if (settingsModalElement) {
                        this.settingsModal = new bootstrap.Modal(settingsModalElement);
                    } else {
                        console.error("Error: settingsModal element not found for Bootstrap Modal initialization.");
                    }
                } else {
                    console.error("Error: Bootstrap is NOT loaded. Check script integrity or network issues.");
                }
                
                // 頁面載入時獲取初始設定和可用欄位
                this.fetchInitialConfigAndColumns();
            },
            methods: {
                // --- 輔助函數：SHA-256 Hashing ---
                async hashString(str) {
                    const textEncoder = new TextEncoder();
                    const data = textEncoder.encode(str);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    return hashedPassword;
                },

                // --- Google Apps Script 互動 ---
                async callGAS(functionName, params = {}) {
                    // **請確保這是您最新部署的 Google Apps Script Web App URL**
                    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzHqfMnW_Z6qVMBOwXkql30xwsazGQbGueEdgW68eLu1uV452zpiO7kSN1yHNb41PPP/exec'; 

                    try {
                        const url = new URL(SCRIPT_URL);
                        url.searchParams.append('function', functionName);
                        for (const key in params) {
                            // 確保參數被正確地 JSON 序列化
                            url.searchParams.append(key, JSON.stringify(params[key]));
                        }

                        const response = await fetch(url.toString(), {
                            method: 'GET',
                            mode: 'cors'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.error) {
                            throw new Error(result.error);
                        }
                        return result;
                    } catch (error) {
                        console.error('GAS Call Error:', error);
                        this.showMessage(`操作失敗：${error.message || '請檢查網路連線或後台設定。'}`, 'alert-danger');
                        return null;
                    }
                },

                // --- 初始載入設定和欄位 ---
                async fetchInitialConfigAndColumns() {
                    this.isLoading = true;
                    this.loadingMessage = '載入初始設定...';
                    try {
                        const result = await this.callGAS('getInitialConfigAndColumns');
                        if (result && result.settings && result.columns) {
                            this.currentSettings = result.settings;
                            this.availableColumns = result.columns;
                            this.tempSettings = { ...this.currentSettings }; // 同步到暫存設定
                            // 首次載入時，如果拉霸項目還是預設值，則觸發一次拉霸
                            if (this.spinnerItems[0] === '載入中...') {
                                this.pullLever();
                            }
                        } else {
                            this.showMessage('無法獲取初始設定或可用欄位列表。', 'alert-danger');
                        }
                    } finally {
                        this.isLoading = false;
                        this.loadingMessage = '載入中...';
                    }
                },

                // --- 主要功能 ---
                async pullLever() {
                    if (this.isLoading) return; // 避免重複點擊

                    this.isLoading = true;
                    this.loadingMessage = '拉霸中...';
                    this.message = ''; // 清除之前的訊息

                    // 觸發動畫
                    this.isSpinning = [true, true, true];

                    try {
                        // Apps Script 會直接從「設定檔」讀取要拉霸的欄位
                        const result = await this.callGAS('getSpinnerData');
                        if (result && result.data) {
                            this.spinnerItems = result.data.map(item => item || '無資料'); // 如果回傳空值，顯示「無資料」
                        } else {
                            this.spinnerItems = ['取得失敗', '取得失敗', '取得失敗'];
                            this.showMessage('未能取得拉霸資料。', 'alert-warning');
                        }
                    } finally {
                        this.isLoading = false;
                        this.loadingMessage = '載入中...';
                    }
                },

                async submitSentence() {
                    if (this.isLoading) return;

                    // 驗證輸入
                    if (!this.userName.trim()) {
                        this.showMessage('請輸入您的姓名！', 'alert-warning', 'animate__headShake');
                        return;
                    }
                    if (!this.userSentence.trim()) {
                        this.showMessage('請輸入您的造句！', 'alert-warning', 'animate__headShake');
                        return;
                    }

                    this.isLoading = true;
                    this.loadingMessage = '送出中...';
                    this.message = ''; // 清除之前的訊息

                    const payload = {
                        spinner1: this.spinnerItems[0],
                        spinner2: this.spinnerItems[1],
                        spinner3: this.spinnerItems[2],
                        name: this.userName,
                        sentence: this.userSentence
                    };

                    try {
                        const result = await this.callGAS('submitSentence', payload);
                        if (result && result.success) {
                            this.showMessage('造句成功送出！', 'alert-success', 'animate__bounceIn');
                            this.userName = '';
                            this.userSentence = '';
                        } else {
                            this.showMessage(`送出失敗：${result.error || '未知錯誤。'}`, 'alert-danger');
                        }
                    } finally {
                        this.isLoading = false;
                        this.loadingMessage = '載入中...';
                    }
                },

                // --- 密碼保護功能 ---
                openPasswordModal() {
                    this.adminPasswordInput = ''; // 清空密碼輸入框
                    this.passwordError = ''; // 清空錯誤訊息
                    if (this.passwordModal) {
                        this.passwordModal.show();
                    } else {
                        console.error("Error: passwordModal is not initialized.");
                        this.showMessage('密碼視窗無法開啟，請檢查錯誤。', 'alert-danger');
                    }
                },

                async verifyPasswordAndOpenSettings() {
                    this.passwordError = '';
                    if (!this.adminPasswordInput) {
                        this.passwordError = '請輸入密碼！';
                        return;
                    }

                    this.isLoading = true;
                    this.loadingMessage = '驗證密碼中...';

                    try {
                        const hashedPassword = await this.hashString(this.adminPasswordInput);
                        const result = await this.callGAS('verifyPassword', { hashedPassword: hashedPassword });

                        if (result && result.success) {
                            if (this.passwordModal) this.passwordModal.hide();
                            if (this.settingsModal) this.settingsModal.show();
                            this.settingsMessage = ''; // 清空設定視窗的錯誤訊息
                            this.newPassword = ''; // 清空修改密碼欄位
                            this.confirmNewPassword = '';
                            this.passwordChangeMessage = ''; // 清空修改密碼訊息
                        } else {
                            this.passwordError = '密碼錯誤，請重新輸入。';
                        }
                    } catch (error) {
                        this.passwordError = `驗證失敗：${error.message || '請檢查網路。'}`;
                    } finally {
                        this.isLoading = false;
                        this.loadingMessage = '載入中...';
                    }
                },

                // --- 設定功能 ---
                async saveSettings() {
                    // 檢查是否有重複選擇的欄位
                    const selected = Object.values(this.tempSettings);
                    const uniqueSelected = new Set(selected);
                    if (uniqueSelected.size !== selected.length) {
                        this.settingsMessage = '三個欄位不能選擇相同的類型！';
                        return;
                    }
                    
                    this.isLoading = true;
                    this.loadingMessage = '儲存設定中...';

                    try {
                        const result = await this.callGAS('saveSettings', { settings: this.tempSettings });
                        if (result && result.success) {
                            this.currentSettings = { ...this.tempSettings }; // 更新生效設定
                            if (this.settingsModal) this.settingsModal.hide();
                            this.showMessage('拉霸設定已儲存！', 'alert-success');
                        } else {
                            this.settingsMessage = `儲存失敗：${result.error || '未知錯誤。'}`;
                        }
                    } catch (error) {
                        this.settingsMessage = `儲存失敗：${error.message || '請檢查網路。'}`;
                    } finally {
                        this.isLoading = false;
                        this.loadingMessage = '載入中...';
                    }
                },

                // --- 修改密碼功能 ---
                async changeAdminPassword() {
                    this.passwordChangeMessage = '';
                    this.passwordChangeMessageType = '';

                    if (!this.newPassword || !this.confirmNewPassword) {
                        this.passwordChangeMessage = '新密碼和確認密碼不能為空！';
                        this.passwordChangeMessageType = 'alert-warning';
                        return;
                    }
                    if (this.newPassword !== this.confirmNewPassword) {
                        this.passwordChangeMessage = '新密碼與確認密碼不一致！';
                        this.passwordChangeMessageType = 'alert-warning';
                        return;
                    }
                    if (this.newPassword.length < 6) { // 建議密碼長度
                        this.passwordChangeMessage = '密碼長度至少為6個字元。';
                        this.passwordChangeMessageType = 'alert-warning';
                        return;
                    }

                    this.isLoading = true;
                    this.loadingMessage = '修改密碼中...';

                    try {
                        const newHashedPassword = await this.hashString(this.newPassword);
                        const result = await this.callGAS('changePassword', { newHashedPassword: newHashedPassword });

                        if (result && result.success) {
                            this.passwordChangeMessage = '密碼修改成功！';
                            this.passwordChangeMessageType = 'alert-success';
                            this.newPassword = '';
                            this.confirmNewPassword = '';
                        } else {
                            this.passwordChangeMessage = `密碼修改失敗：${result.error || '未知錯誤。'}`;
                            this.passwordChangeMessageType = 'alert-danger';
                        }
                    } catch (error) {
                        this.passwordChangeMessage = `密碼修改失敗：${error.message || '請檢查網路。'}`;
                        this.passwordChangeMessageType = 'alert-danger';
                    } finally {
                        this.isLoading = false;
                        this.loadingMessage = '載入中...';
                    }
                },

                // --- 訊息提示 ---
                showMessage(msg, type, animation = 'animate__fadeIn') {
                    this.message = msg;
                    this.messageType = type;
                    this.messageAnimation = animation;
                    setTimeout(() => {
                        this.messageAnimation = 'animate__fadeOut'; // 讓訊息淡出
                        setTimeout(() => this.message = '', 500); // 動畫結束後清除訊息
                    }, 3000); // 訊息顯示 3 秒後開始淡出
                }
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
